<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Äì Manage Products | Zennterior</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    .btn-dark {
      background-color: #1a1a1a;
      border: none;
    }
    .btn-dark:hover {
      background-color: #343434;
    }
    table img {
      width: 70px;
      height: auto;
      border-radius: 8px;
    }
    .btn-add {
  background-color: #1a1a1a; 
  color: white;
  border: none;
}
.btn-add:hover {
  background-color: #343434;
  color: white;
}
    
  </style>
</head>
<body class="bg-light">

<!-- ‚úÖ Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editProductId">
        <div class="mb-2">
          <label>Name</label>
          <input type="text" id="editName" class="form-control">
        </div>
        <div class="mb-2">
          <label>Price</label>
          <input type="number" id="editPrice" class="form-control">
        </div>
        <div class="mb-2">
          <label>Category</label>
          <input type="text" id="editCategory" class="form-control">
        </div>
        <div class="mb-2">
          <label>Stock</label>
          <input type="number" id="editStock" class="form-control">
        </div>
        <div class="mb-2">
          <label>Description</label>
          <textarea id="editDescription" class="form-control"></textarea>
        </div>
        <div class="mb-2">
          <label>Image Path</label>
          <input type="text" id="editImage" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="updateProduct()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- üîº Add Product Modal -->
<div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Add New Product</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label>Name</label>
          <input type="text" id="newName" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Price</label>
          <input type="number" id="newPrice" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Category</label>
          <input type="text" id="newCategory" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Stock</label>
          <input type="number" id="newStock" class="form-control" required>
        </div>
        <div class="mb-2">
          <label>Description</label>
          <textarea id="newDescription" class="form-control"></textarea>
        </div>
        <div class="mb-2">
          <label>Image Path</label>
          <input type="text" id="newImage" class="form-control">
          <small class="text-muted">Ex:assets/products/sofa1.jpg</small>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="addProduct()">Add Product</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Main Content -->
<div class="container py-5">
  <h2 class="text-center mb-4">üõ†Ô∏è Admin ‚Äì Manage Products</h2>
  <div class="d-flex justify-content-between mb-3">
    <button onclick="logout()" class="btn btn-outline-danger">Logout</button>
    <button class="btn btn-dark" onclick="location.href='admin-dashboard.html'">‚¨Ö Dashboard</button>
    <button class="btn btn-add me-2" data-bs-toggle="modal" data-bs-target="#addModal">‚ûï Add Product</button>
  </div>
  <div class="table-responsive">
    <table class="table table-bordered table-hover shadow-sm bg-white">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Image</th>
          <th>Name</th>
          <th>Category</th>
          <th>Price (‚Çπ)</th>
          <th>Stock</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="productTableBody">
        <!-- JS inserts rows here -->
      </tbody>
    </table>
  </div>
  <div id="productMessage" class="text-center mt-4"></div>
</div>

<script>
  const token = localStorage.getItem("token");
  const role = localStorage.getItem("userRole");

  if (!token || role !== "admin") {
    alert("Access denied. Only admin can view this page.");
    window.location.href = "../login.html";
  }

  let products = []; // üî• Global products array

  async function fetchProducts() {
    try {
      const res = await fetch("http://localhost:5005/api/products", {
        headers: {
          Authorization: `Bearer ${token}`,
        },
      });
      products = await res.json(); // save globally
      const tableBody = document.getElementById("productTableBody");
      tableBody.innerHTML = "";

      products.forEach((p, index) => {
        tableBody.innerHTML += `
          <tr>
            <td>${index + 1}</td>
            <td><img src="../${p.image}" class="product-img" alt="${p.name}" /></td>
            <td>${p.name}</td>
            <td>${p.category}</td>
            <td>‚Çπ${p.price}</td>
            <td>${p.stock}</td>
            <td>
              <button class="btn btn-sm btn-warning me-2" onclick="openEditModal('${p._id}')">EDIT</button>
              <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p._id}')">DELETE</button>
            </td>
          </tr>
        `;
      });
    } catch (err) {
      console.error("Fetch error:", err);
      document.getElementById("productMessage").innerHTML = `<span class="text-danger">Error loading products.</span>`;
    }
  }

  function openEditModal(productId) {
    const product = products.find(p => p._id === productId);
    if (!product) return;

    document.getElementById("editProductId").value = product._id;
    document.getElementById("editName").value = product.name;
    document.getElementById("editPrice").value = product.price;
    document.getElementById("editCategory").value = product.category;
    document.getElementById("editStock").value = product.stock;
    document.getElementById("editDescription").value = product.description;
    document.getElementById("editImage").value = product.image;

    const modal = new bootstrap.Modal(document.getElementById("editModal"));
    modal.show();
  }

  async function updateProduct() {
    const id = document.getElementById("editProductId").value;
    const updatedData = {
      name: document.getElementById("editName").value,
      price: document.getElementById("editPrice").value,
      category: document.getElementById("editCategory").value,
      stock: document.getElementById("editStock").value,
      description: document.getElementById("editDescription").value,
      image: document.getElementById("editImage").value
    };

    const res = await fetch(`http://localhost:5005/api/products/${id}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(updatedData)
    });

    const data = await res.json();
    alert("‚úÖ Product updated!");
    location.reload();
  }

  async function deleteProduct(id) {
    if (confirm("Are you sure you want to delete this product?")) {
      const res = await fetch(`http://localhost:5005/api/products/${id}`, {
        method: "DELETE",
        headers: {
          Authorization: `Bearer ${token}`
        }
      });

      const data = await res.json();
      alert(data.message || "‚úÖ Product deleted.");
      location.reload();
    }
  }

  function logout() {
    localStorage.clear();
    window.location.href = "../login.html";
  }

  fetchProducts(); // initial load

  async function addProduct() {
  const token = localStorage.getItem("token");

  const newProduct = {
    name: document.getElementById("newName").value,
    price: document.getElementById("newPrice").value,
    category: document.getElementById("newCategory").value,
    stock: document.getElementById("newStock").value,
    description: document.getElementById("newDescription").value,
    image: document.getElementById("newImage").value
  };

  try {
    const res = await fetch("http://localhost:5005/api/products", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${token}`
      },
      body: JSON.stringify(newProduct)
    });

    const data = await res.json();

    if (res.ok) {
      alert("‚úÖ Product added successfully!");
      location.reload();
    } else {
      alert(`‚ùå Failed: ${data.message || "Unknown error"}`);
    }
  } catch (err) {
    console.error("Add error:", err);
    alert("Something went wrong!");
  }
}

</script>
</body>
</html>
